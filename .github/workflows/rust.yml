name: Release

on:
  pull_request:
    branches: ['main']
    types: ['closed']

jobs:
  build:
    if: github.event.pull_request.merged == true
    name: Build ${{ matrix.target }}
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
    environment: crates.io
    steps:
      - uses: actions/checkout@master
      - uses: actions-rust-lang/setup-rust-toolchain@v1
        with:
          target: aarch64-apple-darwin,aarch64-apple-ios,aarch64-linux-android,aarch64-unknown-linux-gnu,x86_64-apple-darwin,x86_64-apple-ios,x86_64-pc-windows-gnu,x86_64-unknown-linux-gnu
      - name: Build
        run: cargo build --release --locked --target aarch64-apple-darwin --target aarch64-apple-ios --target aarch64-linux-android --target aarch64-unknown-linux-gnu --target x86_64-apple-darwin --target x86_64-apple-ios --target x86_64-pc-windows-gnu --target x86_64-unknown-linux-gnu
      - name: Publish lowlevel-types
        run: cargo publish -p lowlevel-types --locked --target aarch64-apple-darwin --target aarch64-apple-ios --target aarch64-linux-android --target aarch64-unknown-linux-gnu --target x86_64-apple-darwin --target x86_64-apple-ios --target x86_64-pc-windows-gnu --target x86_64-unknown-linux-gnu
      - name: Publish serde-binary-adv
        run: cargo publish -p serde-binary-adv --locked --target aarch64-apple-darwin --target aarch64-apple-ios --target aarch64-linux-android --target aarch64-unknown-linux-gnu --target x86_64-apple-darwin --target x86_64-apple-ios --target x86_64-pc-windows-gnu --target x86_64-unknown-linux-gnu
